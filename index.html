<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghimire Home Library</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <!-- Barcode Scanner Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" 
            xintegrity="sha512-r6rDA7W6ZeQhvl8S7yIZmwG-dsPTUTa0M23sBvy0imzIUAESMRv1OOSdQR9M5+oIDrVstKFj0HnCStOHFHwcsQ==" 
            crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
            
    <!-- PDF & Word Export Libraries (deferred to prevent blocking) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind 'slate-50' */
        }
        /* Custom modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: all 0.25s ease;
        }
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-hidden .modal-content {
            transform: translateY(-20px);
        }
        /* Ensure scanner region is visible */
        #qr-reader {
            width: 100%;
        }
        
        /* Dropdown styles */
        .dropdown-menu {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            transform: translateY(-10px);
        }
        .dropdown-menu.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Style for active filter button */
        .filter-btn-active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
        
        /* Hide elements by default, show when app is ready */
        #app-container, #login-register-container {
            display: none;
        }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- Login/Register Container -->
    <div id="login-register-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Logo and Title -->
            <div class="flex flex-col items-center mb-6">
                <svg class="w-16 h-16 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800 mt-2">Ghimire Home Library</h1>
                <p class="text-gray-600">Please sign in to access the shared library.</p>
            </div>

            <!-- Login / Register Forms -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="login-tab-btn" class="flex-1 py-2 font-medium text-blue-600 border-b-2 border-blue-600">Login</button>
                    <button id="register-tab-btn" class="flex-1 py-2 font-medium text-gray-500 hover:text-gray-700">Register</button>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700">Sign In</button>
                    <p id="login-status" class="text-sm text-red-600 h-4"></p>
                </form>

                <!-- Register Form (Hidden by default) -->
                <form id="register-form" class="hidden space-y-4">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Password (min. 6 characters)</label>
                        <input type="password" id="register-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-code" class="block text-sm font-medium text-gray-700">Invitation Code</label>
                        <input type="text" id="register-code" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-green-700">Register</button>
                    <p id="register-status" class="text-sm text-red-600 h-4"></p>
                </form>
            </div>
        </div>
    </div>


    <!-- Main App Container (Hidden by default) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-6xl">

        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <svg id="app-logo" class="w-12 h-12 sm:w-14 sm:h-14 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <div>
                        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Ghimire Home Library</h1>
                        <p class="text-base sm:text-lg text-gray-600">Ghimire Home Private Library Digital Collection.</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="admin-panel-btn" class="hidden bg-yellow-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-yellow-600 transition text-sm">Admin Panel</button>
                    <button id="sign-out-btn" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition text-sm">Sign Out</button>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

            <!-- Left Column: Add/Scan Book -->
            <div class="md:col-span-1 space-y-6">
                <!-- ISBN Scanner & Search -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Scan or Search ISBN</h2>
                    <button id="scan-btn" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 mb-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                        <span>Scan Barcode</span>
                    </button>
                    <div id="scanner-container" class="hidden my-4 rounded-lg overflow-hidden border border-gray-300">
                        <div id="qr-reader" class="w-full"></div>
                        <button id="stop-scan-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 hover:bg-red-700 transition duration-150">Stop Scanning</button>
                    </div>
                    <div class="relative flex items-center">
                        <input type="text" id="isbn" name="isbn" placeholder="Enter 10 or 13-digit ISBN" class="w-full pl-4 pr-20 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="search-isbn-btn" class="absolute right-1 top-1 bottom-1 bg-blue-600 text-white px-3 rounded-md hover:bg-blue-700 transition duration-150 text-sm font-medium">
                            Search
                        </button>
                    </div>
                    <p id="search-status" class="text-sm text-gray-500 mt-2 h-4"></p>
                </div>

                <!-- Add Book Form -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Add Book Details</h2>
                    <form id="add-book-form" class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700">Title*</label>
                            <input type="text" id="title" name="title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="author" class="block text-sm font-medium text-gray-700">Author*</label>
                            <input type="text" id="author" name="author" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="language" class="block text-sm font-medium text-gray-700">Language</label>
                            <select id="language" name="language" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="English">English</option>
                                <option value="Nepali">Nepali</option>
                                <option value="Sanskrit">Sanskrit</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                        </div>
                        <button type="submit" class="w-full flex items-center justify-center gap-2 bg-green-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-green-700 transition duration-150">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>Add to Library</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Library List -->
            <div class="md:col-span-2">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                        <div class="flex items-center gap-3">
                             <h2 class="text-xl font-semibold text-gray-800">My Library</h2>
                             <span id="book-count-badge" class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full hidden">0</span>
                        </div>
                        
                        <!-- Actions Dropdown (Admin Only) -->
                        <div class="relative mt-3 sm:mt-0 hidden" id="actions-menu-container">
                            <button id="actions-menu-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-gray-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-150 text-sm">
                                <span>Actions</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="actions-menu" class="dropdown-menu absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                                <div class="py-1">
                                    <button id="import-csv-btn" class="w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                        Import from CSV...
                                    </button>
                                    <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                                    <hr class="my-1 border-gray-200">
                                    <button id="export-csv-btn" class="w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                        Export to CSV
                                    </button>
                                    <button id="export-pdf-btn" class="w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                        Export to PDF
                                    </button>
                                    <button id="export-doc-btn" class="w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                        Export to Word (.doc)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Language Filter Buttons -->
                    <div id="language-filter-buttons" class="flex flex-wrap gap-2 mb-4">
                        <button data-lang="All" class="filter-btn text-sm px-3 py-1 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200 filter-btn-active">All</button>
                        <button data-lang="English" class="filter-btn text-sm px-3 py-1 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200">English</button>
                        <button data-lang="Nepali" class="filter-btn text-sm px-3 py-1 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200">Nepali</button>
                        <button data-lang="Sanskrit" class="filter-btn text-sm px-3 py-1 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200">Sanskrit</button>
                        <button data-lang="Other" class="filter-btn text-sm px-3 py-1 rounded-full border border-gray-300 bg-gray-100 text-gray-700 hover:bg-gray-200">Other</button>
                    </div>

                    <!-- Search Bar -->
                    <div class="relative mb-4">
                        <input type="text" id="search-library-input" placeholder="Search by title or author..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                    
                    <div id="book-list" class="space-y-4">
                        <p id="loading-books" class="text-gray-500">Loading your library...</p>
                        <!-- Book items will be dynamically inserted here -->
                    </div>
                </div>
            </div>

        </div> <!-- End Grid -->
    </div> <!-- End App Container -->

    <!-- Global Message Modal -->
    <div id="message-modal" class="modal modal-hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50" style="display: none;">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
            <h3 id="message-title" class="text-xl font-semibold mb-2"></h3>
            <p id="message-body" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end gap-3">
                 <button id="message-cancel-btn" class="bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150" style="display: none;">
                    Cancel
                 </button>
                 <button id="message-confirm-btn" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-150">
                    Close
                 </button>
            </div>
        </div>
    </div>
    
    <!-- "Kept by" Modal -->
    <div id="kept-modal" class="modal modal-hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50" style="display: none;">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
            <h3 class="text-xl font-semibold mb-4">Mark as Kept</h3>
            <form id="kept-form">
                <input type="hidden" id="kept-book-id">
                <div>
                    <label for="borrower-name" class="block text-sm font-medium text-gray-700">Who has this book?</label>
                    <input type="text" id="borrower-name" name="borrower-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="kept-cancel-btn" class="bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150">
                        Mark as Kept
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="modal modal-hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50" style="display: none;">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl">
            <h3 class="text-xl font-semibold mb-4">Admin Panel - Invitation Codes</h3>
            <p class="text-sm text-gray-600 mb-4">You can generate up to 5 invitation codes. Give a code to each member to let them register. Once a code is used, it cannot be used again.</p>
            
            <button id="generate-code-btn" class="w-full bg-green-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-green-700 transition duration-150 mb-4">
                Generate New Code (Max 5)
            </button>
            <p id="admin-status" class="text-sm text-red-600 h-4 mb-2"></p>
            
            <h4 class="font-semibold text-gray-800 mb-2">Generated Codes:</h4>
            <div id="codes-list" class="space-y-2 border border-gray-200 rounded-lg p-3 h-48 overflow-y-auto">
                <p class="text-gray-500">Loading codes...</p>
                <!-- Codes will be injected here -->
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" id="admin-close-btn" class="bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Error Banner for Config Failures -->
    <div id="error-banner" class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white p-4 text-center z-50 flex justify-between items-center">
        <span id="error-banner-message"></span>
        <button id="error-banner-close" class="ml-4 text-xl font-bold leading-none">&times;</button>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc,
            deleteDoc,
            updateDoc,
            onSnapshot, 
            collection, 
            query,
            getDocs,
            getDoc,
            Timestamp,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global App State
        let db, auth;
        let userId;
        let userEmail; // Store user's email for admin check
        const ADMIN_EMAIL = "admin@ghimire.lib";
        let booksCollectionRef;
        let codesCollectionRef;
        let html5QrCode;
        let allBooksData = []; // Main cache of books from Firestore
        let currentFilter = 'All'; // State for language filter
        let configLoaded = false;
        let firebaseConfig = null;
        let appId = 'default-app-id';
        let unsubscribeBooks = null; // To stop the book listener on sign-out
        let unsubscribeCodes = null; // To stop the code listener
        
        // ---------------------------------------------------------------------
        // TODO: PASTE YOUR FIREBASE CONFIG HERE
        // ---------------------------------------------------------------------
        // const firebaseConfig = {
        //   apiKey: "YOUR_API_KEY",
        //   authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        //   projectId: "YOUR_PROJECT_ID",
        //   storageBucket: "YOUR_PROJECT_ID.appspot.com",
        //   messagingSenderId: "YOUR_SENDER_ID",
        //   appId: "YOUR_APP_ID"
        // };
        // ---------------------------------------------------------------------

        // --- Configuration and Initialization ---

        /**
         * Shows a non-modal error banner.
         * @param {string} message - The error message to display.
         */
        function showErrorBanner(message) {
            const banner = document.getElementById('error-banner');
            const bannerMessage = document.getElementById('error-banner-message');
            if (banner && bannerMessage) {
                bannerMessage.textContent = message;
                banner.classList.remove('hidden');
            }
        }
        
        /**
         * Hides the error banner.
         */
        function hideErrorBanner() {
             const banner = document.getElementById('error-banner');
             if (banner) {
                 banner.classList.add('hidden');
             }
        }
        
        /**
         * Disables all app features if config fails.
         */
        function disableAppFeatures(message) {
            showErrorBanner(message);
            // Show the login container, but disable its forms
            const loginContainer = document.getElementById('login-register-container');
            if (loginContainer) {
                loginContainer.style.display = 'flex';
                document.querySelectorAll('#login-form button, #login-form input').forEach(el => el.disabled = true);
                document.querySelectorAll('#register-form button, #register-form input').forEach(el => el.disabled = true);
                const loginTab = document.getElementById('login-tab-btn');
                const regTab = document.getElementById('register-tab-btn');
                if (loginTab) loginTab.disabled = true;
                if (regTab) regTab.disabled = true;
            }
        }

        /**
         * Tries to load Firebase configuration.
         * Returns true on success, false on failure.
         */
        function loadConfig() {
            try {
                // This is the new logic: check if user has pasted their config
                if (!firebaseConfig) {
                    // Check for the environment config as a fallback
                    if (typeof __firebase_config !== 'undefined') {
                        console.warn("Using environment config. For publishing, paste your config into the script.");
                        firebaseConfig = JSON.parse(__firebase_config);
                    } else {
                        throw new Error('PASTE_YOUR_CONFIG_HERE is not set. App cannot start.');
                    }
                }
                
                if (typeof __app_id !== 'undefined') {
                    appId = __app_id;
                } else {
                    // Use project ID from config if available
                    if (firebaseConfig.projectId) {
                        appId = firebaseConfig.projectId;
                    }
                    console.warn(`Using project ID as app ID: ${appId}`);
                }
                
                return true;

            } catch (error) {
                console.error("Configuration Error:", error.message);
                disableAppFeatures(`Configuration Error: ${error.message}. Please follow publishing Step 2.`);
                return false;
            }
        }
        
        /**
         * Initializes the application, Firebase, and auth.
         */
        async function initApp() {
            if (!configLoaded) {
                console.error("Attempted to initApp without loaded config.");
                return; // Stop initialization if config failed
            }
            
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Enable debug logging for Firestore
                setLogLevel('Debug');
                
                // Define collection paths
                // Note: The security rules use 'projectId', so we must use it here.
                const publicDataPath = `artifacts/${appId}/public/data`;
                booksCollectionRef = collection(db, `${publicDataPath}/shared-books`);
                codesCollectionRef = collection(db, `${publicDataPath}/invitation-codes`);

                // Set up Auth Listener
                onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        userEmail = user.email; // Store email
                        
                        // Load books and show the main app
                        loadBooks();
                        showApp(user.email);
                        
                        // If admin, load admin panel data
                        if (user.email === ADMIN_EMAIL) {
                            loadCodes();
                        }
                    } else {
                        console.log("User is signed out or anonymous.");
                        userId = null;
                        userEmail = null;
                        
                        // Stop listening to data
                        if (unsubscribeBooks) unsubscribeBooks();
                        if (unsubscribeCodes) unsubscribeCodes();
                        
                        // Show the login screen
                        showLogin();
                    }
                });

                // Sign In Anonymously (for security rules and initial access)
                await signInAnonymously(auth);
                console.log("Signed in anonymously for initial access.");

                // Initialize UI components and event listeners
                initComponents();

            } catch (error) {
                console.error("Error during app initialization:", error);
                disableAppFeatures('Initialization Error: ' + error.message);
            }
        }
        
        /**
         * Shows the main app and hides the login screen.
         * Configures UI based on admin status.
         */
        function showApp(email) {
            const appEl = document.getElementById('app-container');
            const loginEl = document.getElementById('login-register-container');
            if (appEl) appEl.style.display = 'block';
            if (loginEl) loginEl.style.display = 'none';
            
            const isAdmin = email === ADMIN_EMAIL;
            
            // Show/Hide Admin-only elements
            const adminBtn = document.getElementById('admin-panel-btn');
            const actionsMenu = document.getElementById('actions-menu-container');
            if (adminBtn) adminBtn.style.display = isAdmin ? 'block' : 'none';
            if (actionsMenu) actionsMenu.style.display = isAdmin ? 'block' : 'none';
            
            // Re-render book list to show/hide delete buttons
            renderBookList();
        }
        
        /**
         * Shows the login screen and hides the main app.
         */
        function showLogin() {
            const appEl = document.getElementById('app-container');
            const loginEl = document.getElementById('login-register-container');
            if (appEl) appEl.style.display = 'none';
            if (loginEl) loginEl.style.display = 'flex';
        }

        /**
         * Attaches all event listeners to UI elements.
         */
        function initComponents() {
            try {
                // Login/Register
                safeAttach('login-tab-btn', 'click', () => switchTab('login'));
                safeAttach('register-tab-btn', 'click', () => switchTab('register'));
                safeAttach('login-form', 'submit', handleLogin);
                safeAttach('register-form', 'submit', handleRegister);
                safeAttach('sign-out-btn', 'click', handleSignOut);
            
                // Modals
                safeAttach('message-confirm-btn', 'click', handleMessageConfirm);
                safeAttach('message-cancel-btn', 'click', hideMessage);
                safeAttach('kept-cancel-btn', 'click', hideKeptModal);
                safeAttach('kept-form', 'submit', handleKeptSubmit);
                
                // Admin Panel Modal
                safeAttach('admin-panel-btn', 'click', showAdminModal);
                safeAttach('admin-close-btn', 'click', hideAdminModal);
                safeAttach('generate-code-btn', 'click', handleGenerateCode);
                
                // Form
                safeAttach('add-book-form', 'submit', handleAddBook);

                // ISBN Actions
                safeAttach('scan-btn', 'click', startScan);
                safeAttach('stop-scan-btn', 'click', stopScan);
                safeAttach('search-isbn-btn', 'click', searchISBN);

                // Actions Menu
                safeAttach('actions-menu-btn', 'click', toggleActionsMenu);
                safeAttach('import-csv-btn', 'click', () => document.getElementById('csv-file-input')?.click());
                safeAttach('csv-file-input', 'change', handleImportCSV);
                safeAttach('export-csv-btn', 'click', exportToCSV);
                safeAttach('export-pdf-btn', 'click', exportToPDF);
                safeAttach('export-doc-btn', 'click', exportToDoc);
                
                // Close dropdown if clicking outside
                document.addEventListener('click', (e) => {
                    const container = document.getElementById('actions-menu-container');
                    if (container && !container.contains(e.target)) {
                        document.getElementById('actions-menu')?.classList.remove('show');
                    }
                });

                // Library Search & Filter
                safeAttach('search-library-input', 'input', () => renderBookList());
                document.querySelectorAll('#language-filter-buttons .filter-btn').forEach(btn => {
                    btn.addEventListener('click', handleFilterClick);
                });
                
                // Error banner close
                safeAttach('error-banner-close', 'click', hideErrorBanner);

            } catch (e) {
                console.error("Error attaching listeners:", e);
                showErrorBanner("UI failed to load. Please reload.");
                throw new Error("UI failed to load.");
            }
        }
        
        /**
         * Helper function to safely attach event listeners.
         */
        function safeAttach(id, event, handler) {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener(event, handler);
            } else {
                console.warn(`Element with ID '${id}' not found. Listener not attached.`);
            }
        }
        
        // --- Auth (Login, Register, Sign Out) ---
        
        function switchTab(tab) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const loginTab = document.getElementById('login-tab-btn');
            const regTab = document.getElementById('register-tab-btn');

            if (tab === 'login') {
                if (loginForm) loginForm.classList.remove('hidden');
                if (regForm) regForm.classList.add('hidden');
                if (loginTab) loginTab.classList.add('text-blue-600', 'border-blue-600');
                if (regTab) regTab.classList.remove('text-blue-600', 'border-blue-600');
            } else {
                if (loginForm) loginForm.classList.add('hidden');
                if (regForm) regForm.classList.remove('hidden');
                if (loginTab) loginTab.classList.remove('text-blue-600', 'border-blue-600');
                if (regTab) regTab.classList.add('text-blue-600', 'border-blue-600');
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const statusEl = document.getElementById('login-status');
            statusEl.textContent = 'Signing in...';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle showing the app
                statusEl.textContent = '';
            } catch (error) {
                console.error("Login Error: ", error);
                statusEl.textContent = `Error: ${error.message}`;
                if (error.code === 'auth/operation-not-allowed') {
                    statusEl.textContent = 'Error: Email/Password sign-in is not enabled. Please follow publishing Step 3.';
                }
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const code = document.getElementById('register-code').value.trim();
            const statusEl = document.getElementById('register-status');
            statusEl.textContent = 'Registering...';
            
            if (!code) {
                statusEl.textContent = 'Invitation code is required.';
                return;
            }

            try {
                // 1. Check if invitation code is valid
                const codeDocRef = doc(codesCollectionRef, code);
                const codeDoc = await getDoc(codeDocRef);
                
                if (!codeDoc.exists()) {
                    throw new Error("Invalid invitation code.");
                }
                
                if (codeDoc.data().used) {
                    throw new Error("This invitation code has already been used.");
                }
                
                // 2. Create the user
                await createUserWithEmailAndPassword(auth, email, password);
                
                // 3. Mark the code as used (associate it with the new user's email)
                await updateDoc(codeDocRef, {
                    used: true,
                    usedBy: email,
                    usedAt: serverTimestamp()
                });
                
                // onAuthStateChanged will handle showing the app
                statusEl.textContent = 'Registration successful! Loading library...';

            } catch (error) {
                console.error("Registration Error: ", error);
                statusEl.textContent = `Error: ${error.message}`;
                if (error.code === 'auth/operation-not-allowed') {
                    statusEl.textContent = 'Error: Email/Password sign-in is not enabled. Please follow publishing Step 3.';
                }
            }
        }
        
        async function handleSignOut() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle showing the login screen.
                // We must re-sign in anonymously for the next user.
                await signInAnonymously(auth);
                console.log("Signed out, re-authenticated service anonymously.");
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        }

        // --- Book Management (CRUD + Kept) ---
        
        /**
         * Loads books from Firestore and renders them.
         */
        function loadBooks() {
            if (unsubscribeBooks) unsubscribeBooks(); // Stop previous listener
            
            const q = query(booksCollectionRef);
            unsubscribeBooks = onSnapshot(q, (snapshot) => {
                allBooksData = []; // Clear cache
                snapshot.forEach((doc) => {
                    allBooksData.push({ id: doc.id, ...doc.data() });
                });
                // Call the render function which handles search and grouping
                renderBookList();
            }, (error) => {
                console.error("Error loading books: ", error);
                showMessage('Error', 'Could not load your library. ' + error.message, 'error');
                const loadingEl = document.getElementById('loading-books');
                if (loadingEl) loadingEl.textContent = 'Error loading library.';
            });
        }
        
        /**
         * Filters, sorts, and renders the book list.
         */
        function renderBookList() {
            const bookList = document.getElementById('book-list');
            const loadingMsg = document.getElementById('loading-books');
            const searchTerm = document.getElementById('search-library-input')?.value.toLowerCase() || '';
            
            if (!bookList || !loadingMsg) {
                console.error("Book list or loading message element not found.");
                return;
            }

            bookList.innerHTML = '';
            bookList.appendChild(loadingMsg);

            const langFilteredBooks = allBooksData.filter(book => 
                currentFilter === 'All' || book.language === currentFilter
            );

            const searchFilteredBooks = langFilteredBooks.filter(book =>
                (book.title || '').toLowerCase().includes(searchTerm) ||
                (book.author || '').toLowerCase().includes(searchTerm)
            );
            
            updateBookCount(searchFilteredBooks.length, allBooksData.length);

            if (allBooksData.length === 0) {
                loadingMsg.textContent = 'This library is empty. Add a book to get started!';
                loadingMsg.classList.remove('hidden');
                return;
            }
            if (searchFilteredBooks.length === 0) {
                loadingMsg.textContent = (searchTerm) ? 'No books match your search.' : 'No books in this category.';
                loadingMsg.classList.remove('hidden');
                return;
            }

            loadingMsg.classList.add('hidden');
            searchFilteredBooks.sort((a, b) => (a.title || '').localeCompare(b.title));
            searchFilteredBooks.forEach(book => {
                renderBook(book); // Appends the book item
            });
        }

        /**
         * Renders a single book object into the DOM.
         */
        function renderBook(book) {
            const bookList = document.getElementById('book-list');
            if (!bookList) return;
            
            const bookEl = document.createElement('div');
            bookEl.className = 'p-4 border border-gray-200 rounded-lg shadow-sm bg-white book-item';
            bookEl.dataset.id = book.id;
            
            const borrowerName = book.borrowerName ? escapeHTML(book.borrowerName) : '';
            
            const statusText = book.isKept 
                ? `<span class="font-medium text-purple-700">Kept by: ${borrowerName}</span>`
                : `<span class="font-medium text-green-700">In Library</span>`;

            // Admin-only delete button
            const deleteButtonHTML = (userEmail === ADMIN_EMAIL) ? `
                <button data-action="delete" class="delete-btn text-gray-400 hover:text-red-600 p-1 rounded-full transition-colors" title="Delete Book">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>` : '';

            bookEl.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between sm:items-start">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">${escapeHTML(book.title)}</h3>
                        <p class="text-sm text-gray-600">by ${escapeHTML(book.author)}</p>
                        <p class="text-sm text-gray-500 mt-1">
                            ${book.isbn ? `ISBN: ${escapeHTML(book.isbn)}` : ''}
                            ${book.language ? ` &bull; Language: ${escapeHTML(book.language)}` : ''}
                        </p>
                        ${book.notes ? `<p class="text-sm text-gray-700 mt-2 bg-gray-50 p-2 rounded">${escapeHTML(book.notes)}</p>` : ''}
                    </div>
                    <div class="flex-shrink-0 mt-4 sm:mt-0 sm:ml-4">
                        <p class="text-sm text-right mb-2">${statusText}</p>
                        <div class="flex items-center justify-end gap-2">
                            ${book.isKept
                                ? `<button data-action="return" class="return-btn text-sm bg-green-100 text-green-800 font-medium py-1 px-3 rounded-full hover:bg-green-200 transition-colors">Return</button>`
                                : `<button data-action="kept" class="kept-btn text-sm bg-blue-100 text-blue-800 font-medium py-1 px-3 rounded-full hover:bg-blue-200 transition-colors">Mark Kept</button>`
                            }
                            ${deleteButtonHTML}
                        </div>
                    </div>
                </div>
            `;
            
            // Attach event listeners
            const deleteBtn = bookEl.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => handleDeleteBook(book.id, book.title));
            }
            
            const keptBtn = bookEl.querySelector('.kept-btn');
            if (keptBtn) {
                keptBtn.addEventListener('click', () => showKeptModal(book.id, book.borrowerName));
            }
            
            const returnBtn = bookEl.querySelector('.return-btn');
            if (returnBtn) {
                returnBtn.addEventListener('click', () => handleReturnBook(book.id));
            }

            bookList.appendChild(bookEl);
        }

        /**
         * Handles the submission of the "Add Book" form.
         */
        async function handleAddBook(e) {
            e.preventDefault();
            if (!userId || !userEmail) { // Must be a real user, not anonymous
                showMessage('Error', 'You must be logged in to add a book.', 'error');
                return;
            }

            const form = e.target;
            const title = form.title.value.trim();
            const author = form.author.value.trim();
            const isbnInput = document.getElementById('isbn');
            const isbn = isbnInput.value.trim();
            const language = form.language.value;
            const notes = form.notes.value.trim();

            if (!title || !author) {
                showMessage('Missing Info', 'Please provide at least a Title and Author.', 'error');
                return;
            }

            try {
                await addDoc(booksCollectionRef, {
                    title,
                    author,
                    isbn,
                    language,
                    notes,
                    addedAt: serverTimestamp(),
                    addedBy: userEmail, // Track who added the book
                    isKept: false,
                    borrowerName: null
                });

                showMessage('Success!', 'Your book has been added to the library.', 'success');
                form.reset();
                if (isbnInput) isbnInput.value = '';
                
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('Error', 'Could not add book. ' + error.message, 'error');
            }
        }
        
        /**
         * Deletes a book from Firestore after confirmation.
         */
        function handleDeleteBook(bookId, title) {
            if (userEmail !== ADMIN_EMAIL) {
                showMessage('Error', 'Only admins can delete books.', 'error');
                return;
            }
            
            showMessage(
                'Confirm Delete', 
                `Are you sure you want to permanently delete "${title}"?`, 
                'confirm',
                async () => {
                    try {
                        const bookDocRef = doc(booksCollectionRef, bookId);
                        await deleteDoc(bookDocRef);
                        console.log(`Book ${bookId} deleted.`);
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        showMessage('Error', 'Could not delete book. ' + error.message, 'error');
                    }
                }
            );
        }
        
        /**
         * Shows the modal to mark a book as "Kept".
         */
        function showKeptModal(bookId, currentBorrower) {
            if (!userEmail) { // Must be a real user, not anonymous
                showMessage('Error', 'You must be logged in to use this feature.', 'error');
                return;
            }
            const idInput = document.getElementById('kept-book-id');
            const nameInput = document.getElementById('borrower-name');
            const modal = document.getElementById('kept-modal');
            
            if (idInput) idInput.value = bookId;
            // Pre-fill the name if it's already kept
            if (nameInput) {
                nameInput.value = currentBorrower || '';
                nameInput.focus();
            }
            if (modal) {
                modal.classList.remove('modal-hidden');
                modal.style.display = 'flex';
            }
        }

        /**
         * Hides the "Kept by" modal.
         */
        function hideKeptModal() {
            const modal = document.getElementById('kept-modal');
            const form = document.getElementById('kept-form');
            if (modal) {
                modal.classList.add('modal-hidden');
                modal.style.display = 'none';
            }
            if (form) form.reset();
        }
        
        /**
         * Handles the "Mark as Kept" form submission.
         */
        async function handleKeptSubmit(e) {
            e.preventDefault();
            const bookId = document.getElementById('kept-book-id')?.value;
            const borrowerName = document.getElementById('borrower-name')?.value.trim();
            
            if (!bookId || !borrowerName) {
                showMessage('Error', 'Missing information.', 'error');
                return;
            }
            
            try {
                const bookDocRef = doc(booksCollectionRef, bookId);
                await updateDoc(bookDocRef, {
                    isKept: true,
                    borrowerName: borrowerName,
                    keptBy: userEmail, // Track who marked it
                    keptAt: serverTimestamp()
                });
                console.log(`Book ${bookId} marked as kept by ${borrowerName}.`);
                hideKeptModal();
            } catch (error) {
                console.error("Error marking as kept: ", error);
                showMessage('Error', 'Could not mark book as kept. ' + error.message, 'error');
            }
        }
        
        /**
         * Marks a book as returned.
         */
        async function handleReturnBook(bookId) {
            try {
                const bookDocRef = doc(booksCollectionRef, bookId);
                await updateDoc(bookDocRef, {
                    isKept: false,
                    borrowerName: null,
                    keptBy: null,
                    keptAt: null
                });
                console.log(`Book ${bookId} returned.`);
            } catch (error) {
                console.error("Error returning book: ", error);
                showMessage('Error', 'Could not return book. ' + error.message, 'error');
            }
        }
        
        // --- Admin Panel ---

        function showAdminModal() {
            const modal = document.getElementById('admin-modal');
            if (modal) {
                 modal.classList.remove('modal-hidden');
                 modal.style.display = 'flex';
            }
        }
        
        function hideAdminModal() {
            const modal = document.getElementById('admin-modal');
            if (modal) {
                modal.classList.add('modal-hidden');
                modal.style.display = 'none';
            }
        }
        
        /**
         * Generates a new unique invitation code (max 5).
         */
        async function handleGenerateCode() {
            const statusEl = document.getElementById('admin-status');
            statusEl.textContent = 'Generating...';
            
            try {
                const codesSnapshot = await getDocs(codesCollectionRef);
                if (codesSnapshot.size >= 5) {
                    throw new Error("You have already generated the maximum of 5 codes.");
                }
                
                // Generate a new 8-char code
                const newCode = crypto.randomUUID().substring(0, 8).toUpperCase();
                
                // Add it to the database
                await setDoc(doc(codesCollectionRef, newCode), {
                    code: newCode,
                    createdAt: serverTimestamp(),
                    used: false,
                    usedBy: null,
                    usedAt: null
                });
                
                statusEl.textContent = `New code generated: ${newCode}`;
                // The onSnapshot listener (loadCodes) will automatically update the list
                
            } catch(error) {
                console.error("Error generating code:", error);
                statusEl.textContent = `Error: ${error.message}`;
            }
        }
        
        /**
         * Loads and displays the list of generated codes in the admin panel.
         */
        function loadCodes() {
            if (unsubscribeCodes) unsubscribeCodes(); // Stop previous listener
            
            const q = query(codesCollectionRef);
            unsubscribeCodes = onSnapshot(q, (snapshot) => {
                const codesList = document.getElementById('codes-list');
                if (!codesList) return;
                
                codesList.innerHTML = ''; // Clear list
                
                if (snapshot.empty) {
                    codesList.innerHTML = '<p class="text-gray-500">No codes generated yet.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const code = doc.data();
                    const el = document.createElement('div');
                    el.className = 'p-2 border-b border-gray-100';
                    
                    let statusHTML;
                    if (code.used) {
                        statusHTML = `<span class="text-sm text-red-600">Used by ${escapeHTML(code.usedBy || 'Unknown')}</span>`;
                    } else {
                        statusHTML = `<span class="text-sm text-green-600">Available</span>`;
                    }
                    
                    el.innerHTML = `
                        <p class="font-mono text-lg text-gray-800">${escapeHTML(code.code)}</p>
                        ${statusHTML}
                    `;
                    codesList.appendChild(el);
                });
                
            }, (error) => {
                console.error("Error loading codes:", error);
                const codesList = document.getElementById('codes-list');
                if (codesList) codesList.innerHTML = '<p class="text-red-500">Error loading codes.</p>';
            });
        }


        // --- ISBN & Scanning ---

        function startScan() {
            if (!html5QrCode) {
                if (typeof Html5Qrcode === 'undefined') {
                    console.error("Html5Qrcode library is not loaded.");
                    showMessage('Scanner Error', 'Scanner library failed to load. Please reload the page.', 'error');
                    return;
                }
                try {
                    html5QrCode = new Html5Qrcode("qr-reader");
                } catch (e) {
                    console.error("Error initializing Html5Qrcode:", e);
                    showMessage('Scanner Error', 'Failed to initialize scanner. ' + e.message, 'error');
                    return;
                }
            }
            const scannerContainer = document.getElementById('scanner-container');
            if (scannerContainer) scannerContainer.classList.remove('hidden');

            const onScanSuccess = (decodedText, decodedResult) => {
                console.log(`Scan result: ${decodedText}`);
                const statusEl = document.getElementById('search-status');
                if (/^(\d{10}|\d{12}|\d{13})$/.test(decodedText)) {
                    document.getElementById('isbn').value = decodedText;
                    if (statusEl) statusEl.textContent = 'Scan successful!';
                    stopScan();
                    searchISBN();
                } else {
                    console.warn(`Scanned value is not a valid ISBN: ${decodedText}`);
                    if (statusEl) statusEl.textContent = 'Scanned code not a valid ISBN.';
                }
            };
            const config = { 
                fps: 10, 
                qrbox: { width: 300, height: 150 },
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E
                ]
            };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                console.error("Cannot start scanner: ", err);
                if (scannerContainer) scannerContainer.classList.add('hidden');
                showMessage('Scanner Error', 'Could not start camera. ' + err, 'error');
            });
        }

        function stopScan() {
            const scannerContainer = document.getElementById('scanner-container');
            if (scannerContainer) scannerContainer.classList.add('hidden');
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(ignore => {
                    console.log("Scanner stopped.");
                }).catch(err => {
                    console.warn("Scanner stop failed: ", err);
                });
            }
        }
        
        async function searchISBN() {
            const isbnInput = document.getElementById('isbn');
            const isbn = isbnInput?.value.trim();
            if (!isbn) {
                showMessage('ISBN Required', 'Please enter an ISBN to search.', 'error');
                return;
            }
            const statusEl = document.getElementById('search-status');
            if (statusEl) statusEl.textContent = 'Searching...';
            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.totalItems > 0) {
                    const book = data.items[0].volumeInfo;
                    const titleEl = document.getElementById('title');
                    const authorEl = document.getElementById('author');
                    const langSelect = document.getElementById('language');
                    if (titleEl) titleEl.value = book.title || '';
                    if (authorEl) authorEl.value = book.authors ? book.authors.join(', ') : '';
                    if (langSelect) {
                        const langCode = book.language || '';
                        if (langCode === 'en') langSelect.value = 'English';
                        else if (langCode === 'ne') langSelect.value = 'Nepali';
                        else if (langCode === 'sa') langSelect.value = 'Sanskrit';
                        else if (langCode) langSelect.value = 'Other';
                        else langSelect.value = 'English';
                    }
                    if (statusEl) statusEl.textContent = 'Book found!';
                } else {
                    if (statusEl) statusEl.textContent = 'No book found for that ISBN.';
                }
            } catch (error) {
                console.error('Error fetching book data:', error);
                if (statusEl) statusEl.textContent = 'Search failed.';
                showMessage('API Error', 'Could not fetch book data. ' + error.message, 'error');
            }
        }
        
        // --- UI Handlers (Modals, Menus, Filters) ---

        function showMessage(title, body, type = 'info', onConfirm = null) {
            if (!body) return; // Don't show modal if body is empty
            const modal = document.getElementById('message-modal');
            const titleEl = document.getElementById('message-title');
            const bodyEl = document.getElementById('message-body');
            const confirmBtn = document.getElementById('message-confirm-btn');
            const cancelBtn = document.getElementById('message-cancel-btn');
            if (!modal || !titleEl || !bodyEl || !confirmBtn || !cancelBtn) return;

            titleEl.textContent = title;
            bodyEl.textContent = body;
            
            // Reset/re-attach listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            if (type === 'confirm' && onConfirm) {
                newConfirmBtn.textContent = 'Confirm';
                newConfirmBtn.className = 'bg-red-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-red-700 transition duration-150';
                newConfirmBtn.onclick = () => { onConfirm(); hideMessage(); };
                newCancelBtn.textContent = 'Cancel';
                newCancelBtn.style.display = 'inline-block';
                newCancelBtn.onclick = hideMessage;
            } else {
                newConfirmBtn.textContent = 'Close';
                newConfirmBtn.className = 'bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-150';
                newConfirmBtn.onclick = hideMessage;
                newCancelBtn.style.display = 'none';
            }
            titleEl.classList.toggle('text-red-600', type === 'error');
            modal.classList.remove('modal-hidden');
            modal.style.display = 'flex';
        }

        function hideMessage() {
            const modal = document.getElementById('message-modal');
            if (modal) {
                modal.classList.add('modal-hidden');
                // Use timeout to allow CSS animation to finish before hiding
                setTimeout(() => {
                    if (modal.classList.contains('modal-hidden')) { // Check if still hidden
                        modal.style.display = 'none';
                    }
                }, 300);
            }
        }
        
        function handleMessageConfirm() { hideMessage(); }
        
        function toggleActionsMenu() {
            const menu = document.getElementById('actions-menu');
            if (menu) menu.classList.toggle('show');
        }
        
        function handleFilterClick(e) {
            const clickedBtn = e.target;
            const lang = clickedBtn.dataset.lang;
            if (!lang) return;
            currentFilter = lang;
            document.querySelectorAll('#language-filter-buttons .filter-btn').forEach(btn => {
                btn.classList.remove('filter-btn-active');
            });
            clickedBtn.classList.add('filter-btn-active');
            renderBookList();
        }
        
        function updateBookCount(displayed, total) {
             const badge = document.getElementById('book-count-badge');
             if (badge) {
                 if (total === 0) {
                     badge.classList.add('hidden');
                     return;
                 }
                 badge.classList.remove('hidden');
                 if (displayed === total) {
                     badge.textContent = `${total} books`;
                 } else {
                     badge.textContent = `Showing ${displayed} of ${total} books`;
                 }
             }
        }

        // --- Import/Export (Admin Only) ---
        
        function handleImportCSV(e) {
            if (userEmail !== ADMIN_EMAIL) {
                showMessage('Error', 'Only admins can import books.', 'error');
                return;
            }
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const csv = event.target.result;
                try {
                    const importedBooks = parseCSV(csv);
                    if (importedBooks.length > 0) {
                        showMessage(
                            'Confirm Import',
                            `Are you sure you want to import ${importedBooks.length} books? This will add them to the shared library.`,
                            'confirm',
                            async () => {
                                // Add all books to Firestore
                                try {
                                    const promises = importedBooks.map(book => addDoc(booksCollectionRef, book));
                                    await Promise.all(promises);
                                    showMessage('Success', `${importedBooks.length} books were imported.`, 'success');
                                    // List will update via onSnapshot
                                } catch (err) {
                                    showMessage('Import Error', `Error saving books: ${err.message}`, 'error');
                                }
                            }
                        );
                    } else {
                        showMessage('Import Error', 'The file was empty or in an invalid format.', 'error');
                    }
                } catch (err) {
                    console.error("Error parsing CSV:", err);
                    showMessage('Import Error', `Could not parse CSV file. ${err.message}`, 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = null;
        }

        function parseCSV(csv) {
            const lines = csv.split(/\r\n|\n/);
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const books = [];
            
            const titleIdx = headers.indexOf('title');
            const authorIdx = headers.indexOf('author');
            const isbnIdx = headers.indexOf('isbn');
            const langIdx = headers.indexOf('language');
            const notesIdx = headers.indexOf('notes');

            if (titleIdx === -1 || authorIdx === -1) {
                throw new Error("Invalid CSV. Must contain 'Title' and 'Author' columns.");
            }

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i]) continue;
                const data = lines[i].split(','); // Simple parse
                const title = data[titleIdx] ? data[titleIdx].replace(/"/g, '') : '';
                const author = data[authorIdx] ? data[authorIdx].replace(/"/g, '') : '';
                
                if (title && author) {
                    books.push({
                        // No local ID needed, Firestore will generate
                        title: title,
                        author: author,
                        isbn: data[isbnIdx] ? data[isbnIdx].replace(/"/g, '') : '',
                        language: data[langIdx] ? data[langIdx].replace(/"/g, '') : 'English',
                        notes: data[notesIdx] ? data[notesIdx].replace(/"/g, '') : '',
                        addedAt: serverTimestamp(),
                        addedBy: userEmail,
                        isKept: false,
                        borrowerName: null
                    });
                }
            }
            return books;
        }

        function exportToCSV() {
            if (userEmail !== ADMIN_EMAIL) return;
            if (allBooksData.length === 0) {
                showMessage('Empty Library', 'There are no books to export.', 'info');
                return;
            }
            try {
                const headers = ['Title', 'Author', 'ISBN', 'Language', 'Notes', 'Status', 'Kept By'];
                const rows = allBooksData.map(book => [
                    `"${(book.title || '').replace(/"/g, '""')}"`,
                    `"${(book.author || '').replace(/"/g, '""')}"`,
                    `"${book.isbn || ''}"`,
                    `"${book.language || ''}"`,
                    `"${(book.notes || '').replace(/"/g, '""')}"`,
                    book.isKept ? 'Kept' : 'In Library',
                    `"${book.borrowerName || ''}"`
                ]);
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += headers.join(',') + '\r\n';
                csvContent += rows.join('\r\n');
                downloadFile(csvContent, "ghimire_home_library.csv", "text/csv");
            } catch (error) {
                console.error("Error exporting CSV:", error);
                showMessage('Export Error', 'Could not generate CSV file. ' + error.message, 'error');
            }
        }
        
        async function exportToPDF() {
            if (userEmail !== ADMIN_EMAIL) return;
            if (allBooksData.length === 0) {
                showMessage('Empty Library', 'There are no books to export.', 'info');
                return;
            }
            showMessage('Generating PDF', 'Please wait... this may take a moment.', 'info');
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('PDF export library (jsPDF) is not loaded yet. Please try again in a moment.');
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;

                doc.setFontSize(18);
                doc.text("Ghimire Home Library", margin, y);
                y += 10;
                doc.setFontSize(12);
                doc.text(`Total Books: ${allBooksData.length}`, margin, y);
                y += 15;
                
                const sortedBooks = [...allBooksData].sort((a,b) => (a.title || '').localeCompare(b.title));

                sortedBooks.forEach((book, index) => {
                    if (y > pageHeight - 40) { 
                        doc.addPage();
                        y = 20;
                    }
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(book.title || 'No Title', margin, y);
                    y += 7;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`by ${book.author || 'No Author'}`, margin, y);
                    y += 5;
                    doc.setFontSize(9);
                    doc.setTextColor(80);
                    doc.text(`Status: ${book.isKept ? 'Kept by ' + book.borrowerName : 'In Library'}`, margin, y);
                    y += 5;
                    doc.text(`ISBN: ${book.isbn || 'N/A'} | Language: ${book.language || 'N/A'}`, margin, y);
                    y += 10;
                });
                
                doc.save("ghimire_home_library.pdf");
                hideMessage();
            } catch (error) {
                console.error("Error exporting PDF:", error);
                showMessage('Export Error', `Could not generate PDF file. ${error.message}`, 'error');
            }
        }

        function exportToDoc() {
            if (userEmail !== ADMIN_EMAIL) return;
            if (allBooksData.length === 0) {
                showMessage('Empty Library', 'There are no books to export.', 'info');
                return;
            }
            try {
                let htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head><meta charset='utf-8'><title>Ghimire Home Library</title></head>
                    <body>
                        <h1>Ghimire Home Library</h1>
                        <p>Total Books: ${allBooksData.length}</p>
                        <hr>
                `;
                const sortedBooks = [...allBooksData].sort((a,b) => (a.title || '').localeCompare(b.title));
                sortedBooks.forEach(book => {
                    htmlContent += `
                        <div>
                            <h3>${escapeHTML(book.title) || 'No Title'}</h3>
                            <p><em>by ${escapeHTML(book.author) || 'No Author'}</em></p>
                            <p>
                                <strong>Status:</strong> ${book.isKept ? 'Kept by ' + escapeHTML(book.borrowerName) : 'In Library'}<br>
                                <strong>ISBN:</strong> ${book.isbn || 'N/A'}<br>
                                <strong>Language:</strong> ${book.language || 'N/A'}
                            </p>
                            ${book.notes ? `<p><strong>Notes:</strong> ${escapeHTML(book.notes)}</p>` : ''}
                            <hr>
                        </div>
                    `;
                });
                htmlContent += "</body></html>";
                const dataUri = 'data:application/msword;charset=utf-8,' + encodeURIComponent(htmlContent);
                downloadFile(dataUri, "ghimire_home_library.doc");
            } catch(error) {
                console.error("Error exporting DOC:", error);
                showMessage('Export Error', `Could not generate .doc file. ${error.message}`, 'error');
            }
        }
        
        function downloadFile(dataUri, filename) {
            const link = document.createElement("a");
            link.setAttribute("href", dataUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

        // --- App Entry Point ---
        
        // Load config first
        configLoaded = loadConfig();
        
        // Only initialize if config was successful
        if (configLoaded) {
            // Run the app once the DOM is loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initApp);
            } else {
                initApp(); // DOM is already ready
            }
        } else {
            console.error("App initialization skipped due to configuration error.");
            // Error banner already shown by loadConfig()
        }

    </script>
</body>
</html>

